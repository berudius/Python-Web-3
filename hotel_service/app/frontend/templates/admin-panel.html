<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <title>Адмін-панель - Edemium</title>
    <style>
        :root {
            --accent: #2b7a78;
            --accent-dark: #1f5f5d;
            --muted: #64748b;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            
            /* Status Colors */
            --success-bg: #dcfce7;
            --success-text: #166534;
            --warning-bg: #fef3c7;
            --warning-text: #92400e;
            --danger-bg: #fee2e2;
            --danger-text: #991b1b;
            --info-bg: #e0f2fe;
            --info-text: #075985;
            --gray-bg: #f3f4f6;
            --gray-text: #4b5563;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; margin: 0; background: var(--bg); color: #0f172a; line-height: 1.5; }

        header { position: fixed; top: 0; left: 0; width: 100%; padding: 16px 24px; background: white; border-bottom: 1px solid var(--border); z-index: 50; transition: transform 0.3s ease; }
        header.hide { transform: translateY(-100%); }
        header.show { transform: translateY(0); }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .nav { display: flex; align-items: center; justify-content: space-between; }
        .brand a { display: flex; align-items: center; gap: 12px; text-decoration: none; color: #0f172a; }
        .logo { width: 40px; height: 40px; border-radius: 8px; background: var(--accent); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px; }
        
        nav ul { display: flex; gap: 24px; list-style: none; margin: 0; padding: 0; }
        nav li a { font-size: 14px; color: var(--muted); font-weight: 500; text-decoration: none; transition: color 0.2s; }
        nav li a:hover { color: var(--accent); }
        
        .actions { display: flex; gap: 12px; }
        .cta, .cta-outline { padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 14px; text-decoration: none; transition: all 0.2s; cursor: pointer; border: none;}
        .cta { background: var(--accent); color: white; }
        .cta:hover { background: var(--accent-dark); }
        .cta-outline { border: 1px solid var(--border); color: #0f172a; background: white; }
        .cta-outline:hover { border-color: var(--accent); color: var(--accent); }

        main { padding-top: 100px; padding-bottom: 60px; }
        .spacer { margin-top: 110px; }

        h1 { font-size: 24px; font-weight: 700; margin-bottom: 24px; color: #0f172a; }
        h2 { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #334155; display: flex; align-items: center; gap: 10px;}
        
        .card { background: var(--card-bg); border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); overflow: hidden; margin-bottom: 24px; }
        
        .message-card { padding: 16px; border-radius: 12px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; font-size: 14px; }
        .message-card.success { background: var(--success-bg); color: var(--success-text); border: 1px solid #bbf7d0; }

        /* --- ADMIN FILTERS --- */
        .admin-controls { padding: 16px; background: #f8fafc; border-bottom: 1px solid var(--border); }
        .filter-form { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
        .filter-input, .filter-select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; }
        .filter-label { font-size: 12px; color: var(--muted); font-weight: 600; margin-right: 8px;}

        /* --- TABLE STYLES --- */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { text-align: left; padding: 16px 24px; background: #f8fafc; border-bottom: 1px solid var(--border); font-size: 12px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 20px 24px; border-bottom: 1px solid var(--border); vertical-align: top; font-size: 14px; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #fcfcfc; }

        /* --- CELL COMPONENTS --- */
        .booking-id { font-weight: 700; color: #0f172a; font-family: monospace; font-size: 15px; }
        .meta-date { display: block; font-size: 12px; color: var(--muted); margin-top: 4px; }
        .date-range { display: flex; align-items: center; gap: 8px; font-weight: 600; color: #334155; }
        .time-badge { font-size: 12px; color: var(--muted); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; margin-left: 4px; font-weight: 500; }
        .room-tag { display: inline-block; background: #f1f5f9; padding: 4px 8px; border-radius: 6px; font-size: 13px; color: #475569; margin-bottom: 4px; border: 1px solid #e2e8f0; }
        
        .guest-info { display: flex; flex-direction: column; gap: 2px; }
        .guest-id a { font-weight: 600; color: var(--accent); font-size: 13px; text-decoration: none; }
        .guest-phone { color: #475569; font-size: 13px; }

        /* Status Badges */
        .status-badge { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 99px; font-size: 12px; font-weight: 600; }
        .status-badge[data-status="Підтверджено"] { background: var(--success-bg); color: var(--success-text); }
        .status-badge[data-status="Завершено"] { background: var(--info-bg); color: var(--info-text); }
        .status-badge[data-status="Розглядається"] { background: var(--warning-bg); color: var(--warning-text); }
        .status-badge[data-status="Відхилено"] { background: var(--danger-bg); color: var(--danger-text); }
        .status-badge[data-status="Скасовано клієнтом"] { background: var(--gray-bg); color: var(--gray-text); text-decoration: line-through; }

        .action-select { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: white; font-size: 13px; cursor: pointer; max-width: 160px;}
        
        /* User Table Specifics */
        .trust-input { width: 60px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; }
        .btn-mini { padding: 4px 8px; font-size: 12px; border-radius: 6px; cursor: pointer; border: 1px solid var(--border); background: white; }
        .btn-mini:hover { border-color: var(--accent); color: var(--accent); }

        hr { border: none; border-top: 1px solid #e2e8f0; margin: 40px 0; }
    </style>
</head>

<body>
    <header>
        <div class="container nav">
            <div class="brand">
                <a href="{{HOTEL_SERVICE_URL}}/">
                    <div class="logo">E</div>
                    <div>
                        <div style="font-weight:700">Edemium</div>
                        <div style="font-size:12px; color:var(--muted)">Цифровий сервіс готельної мережі</div>
                    </div>
                </a>
            </div>

            <nav aria-label="Головне меню">
                <ul>
                    <li><a href="{{ HOTEL_SERVICE_URL }}/rooms">Номери</a></li>
                    <li><a href="{{ HOTEL_SERVICE_URL }}/services">Сервіси</a></li>
                    <li><a href="{{ HOTEL_SERVICE_URL }}/my-bookings">Мої бронювання</a></li>
                    {% if is_admin %}
                    <li><a href="{{ HOTEL_SERVICE_URL }}/admin/panel">Адмін панель</a></li>
                    {% endif %}
                    <li><a href="{{ HOTEL_SERVICE_URL }}/about_us">Про нас</a></li>
                </ul>
            </nav>

            <div class="actions">
                {% if not is_authorized %}
                <a class="cta-outline" href="{{ USER_SERVICE_URL }}/login">Увійти</a>
                {% else %}
                <a class="cta-outline" href="{{ USER_SERVICE_URL }}/logout">Вийти</a>
                {% endif %}
                <a class="cta" href="{{ HOTEL_SERVICE_URL }}/rooms">Забронювати</a>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="spacer"></div>
        <h1>Адмін-панель</h1>

        {% if success_message %}
        <div class="message-card success">
            <span>{{ success_message }}</span>
        </div>
        {% endif %}

        <section>
            <h2>Керування бронюваннями ({{ all_bookings|length }})</h2>
            
            <div class="card" style="margin-bottom: 24px;">
                <div class="admin-controls">
                    <form method="get" action="{{HOTEL_SERVICE_URL}}/admin/panel" class="filter-form">
                        <span class="filter-label">Фільтр:</span>
                        <select name="status_filter" class="filter-select">
                            <option value="">Всі статуси</option>
                            <option value="Розглядається">Розглядається</option>
                            <option value="Підтверджено">Підтверджено</option>
                            <option value="Завершено">Завершено</option>
                            <option value="Відхилено">Відхилено</option>
                            <option value="Скасовано клієнтом">Скасовано клієнтом</option>
                        </select>
                        <input type="text" name="phone_filter" placeholder="Телефон клієнта..." class="filter-input">
                        <button type="submit" class="cta" style="padding: 8px 16px; font-size: 14px;">Знайти</button>
                        <a href="{{HOTEL_SERVICE_URL}}/admin/panel" class="cta-outline" style="padding: 8px 16px; font-size: 14px;">Скинути</a>
                    </form>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th width="15%">Бронювання</th>
                                <th width="25%">Період проживання</th>
                                <th width="20%">Номери</th>
                                <th width="20%">Гість</th>
                                <th width="10%">Статус</th>
                                <th width="10%">Дії</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in all_bookings %}
                            <tr id="booking-row-{{ booking.id }}">
                                <td>
                                    <div class="booking-id">#{{ booking.id }}</div>
                                    <span class="meta-date">
                                        {{ booking.order_date.strftime('%d.%m.%y %H:%M') if booking.order_date else '-' }}
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <div class="date-range">
                                            <span>{{ booking.arrival_date.strftime('%d.%m.%Y') }}</span>
                                            <span class="time-badge">{{ booking.arrival_date.strftime('%H:%M') }}</span>
                                        </div>
                                        <div class="date-range">
                                            <span>{{ booking.departure_date.strftime('%d.%m.%Y') }}</span>
                                            <span class="time-badge">{{ booking.departure_date.strftime('%H:%M') }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        {% for pr in booking.physical_rooms %}
                                            <span class="room-tag">
                                                <strong>№ {{ pr.room_number }}</strong> ({{ pr.room_model.type }})
                                            </span>
                                        {% else %}
                                            {% for room in booking.rooms %}
                                                <span class="room-tag">{{ room.type }}</span>
                                            {% endfor %}
                                        {% endfor %}
                                    </div>
                                </td>
                                <td>
                                    <div class="guest-info">
                                        {% if booking.user_id %}
                                            <div class="guest-id">User #{{ booking.user_id }}</div>
                                        {% else %}
                                            <span style="font-weight: 600; color: #64748b;">Гість</span>
                                        {% endif %}
                                        <a href="tel:{{ booking.phone_number }}" class="guest-phone">{{ booking.phone_number }}</a>
                                    </div>
                                </td>
                                <td>
                                    <span class="status-badge" id="status-badge-{{ booking.id }}" data-status="{{ booking.status }}">
                                        {{ booking.status }}
                                    </span>
                                </td>
                                <td>
                                    <select class="action-select" onchange="updateStatus({{ booking.id }}, this.value)">
                                        <option value="" disabled selected>Змінити...</option>
                                        <option value="Розглядається">Розглядається</option>
                                        <option value="Підтверджено">Підтверджено</option>
                                        <option value="Завершено">Завершено</option>
                                        <option value="Відхилено">Відхилено</option>
                                    </select>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <hr>

        <section>
            <h2>Керування користувачами ({{ all_users|length }})</h2>
            
            <div class="card table-responsive" style="padding: 0;">
                <table>
                    <thead>
                        <tr>
                            <th width="10%">ID</th>
                            <th width="25%">Користувач</th>
                            <th width="25%">Контакти</th>
                            <th width="20%">Рівень довіри (0-3)</th>
                            <th width="20%">Дії</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in all_users %}
                        <tr>
                            <td><span class="booking-id">#{{ user.id }}</span></td>
                            <td>
                                <div class="guest-info">
                                    <span style="font-weight: 600;">{{ user.login }}</span>
                                    <span style="font-size: 12px; color: var(--muted);">{{ user.role }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="guest-info">
                                    <span class="guest-phone">{{ user.phone_number or 'Не вказано' }}</span>
                                    <span style="font-size: 12px; color: var(--muted);">{{ user.email or '' }}</span>
                                </div>
                            </td>
                            <td>
                                <form method="post" action="{{HOTEL_SERVICE_URL}}/admin/users/trust/{{ user.id }}" style="margin: 0; display: flex; gap: 8px; align-items: center;">
                                    <input type="number" name="trust_level" value="{{ user.trust_level }}" min="0" max="3" class="trust-input">
                                    <button type="submit" class="btn-mini">Ок</button>
                                </form>
                            </td>
                            <td>
                                <span style="color: #cbd5e1;">—</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        // Ховання хедера при скролі
        let lastScroll = 0;
        const header = document.querySelector("header");
        window.addEventListener("scroll", () => {
            const currentScroll = window.pageYOffset;
            if (currentScroll <= 0) { header.classList.remove("hide"); header.classList.add("show"); return; }
            if (currentScroll > lastScroll && !header.classList.contains("hide")) { header.classList.remove("show"); header.classList.add("hide"); } 
            else if (currentScroll < lastScroll && header.classList.contains("hide")) { header.classList.remove("hide"); header.classList.add("show"); }
            lastScroll = currentScroll;
        });

        async function updateStatus(bookingId, newStatus) {
            if (!confirm(`Змінити статус на "${newStatus}"?`)) return;
            try {
                const response = await fetch(`{{HOTEL_SERVICE_URL}}/admin/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                const result = await response.json();
                if (response.ok) {
                    const statusBadge = document.getElementById(`status-badge-${bookingId}`);
                    if (statusBadge) {
                        statusBadge.textContent = newStatus;
                        statusBadge.setAttribute('data-status', newStatus);
                    }
                    if(result.message) alert(result.message);
                    else alert('Статус оновлено!');
                } else {
                    throw new Error(result.detail || result.message || 'Помилка');
                }
            } catch (error) {
                console.error(error);
                alert(`Помилка: ${error.message}`);
            }
        }
    </script>
</body>
</html>